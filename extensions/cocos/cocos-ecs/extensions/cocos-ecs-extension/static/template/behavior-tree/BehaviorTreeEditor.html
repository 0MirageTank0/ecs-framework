<!-- 头部工具栏 -->
<div class="header-toolbar">
    <div class="toolbar-left">
        <h2>🌳 行为树可视化编辑器 
            <span v-if="currentFileName" class="current-file">- {{ currentFileName }}</span>
            <span v-if="hasUnsavedChanges" class="unsaved-indicator">●</span>
        </h2>
        <div class="toolbar-buttons">
            <button class="tool-btn" @click="newBehaviorTree" title="新建行为树">
                <span>📄</span> 新建
            </button>
            <button class="tool-btn" :class="{ 'has-changes': hasUnsavedChanges }" @click="saveBehaviorTree" :title="currentFilePath ? '保存到: ' + currentFilePath : (currentFileName ? '另存为 ' + currentFileName : '保存行为树')">
                <span>💾</span> 保存{{ hasUnsavedChanges ? ' *' : '' }}
            </button>
            <button class="tool-btn" @click="saveAsBehaviorTree" title="另存为新文件">
                <span>💾</span> 另存为
            </button>
            <button class="tool-btn" @click="loadBehaviorTree" title="加载行为树">
                <span>📂</span> 加载
            </button>
            <button class="tool-btn" @click="exportConfig" title="导出配置">
                <span>⚡</span> 导出配置
            </button>
        </div>
    </div>
    <div class="toolbar-right">
        <div class="install-status-container">
            <div class="install-status" :class="installStatusClass()">
                <div class="status-info">
                    <span class="status-icon">{{ isInstalled ? '✅' : (isInstalling ? '⏳' : '❌') }}</span>
                    <div class="status-text">
                        <span class="main-text">{{ installStatusText() }}</span>
                        <span v-if="version && isInstalled" class="version-text">版本 {{ version }}</span>
                    </div>
                </div>
                <button 
                    v-if="!isInstalled" 
                    @click="handleInstall" 
                    :disabled="isInstalling"
                    class="install-btn"
                    :class="{ 'installing': isInstalling }"
                >
                    <span class="btn-icon">{{ isInstalling ? '⏳' : '📦' }}</span>
                    <span class="btn-text">{{ isInstalling ? '安装中...' : '立即安装' }}</span>
                    <div v-if="isInstalling" class="loading-dots">
                        <span></span><span></span><span></span>
                    </div>
                </button>
                <button 
                    v-if="isInstalled && !checkingStatus" 
                    @click="checkInstallStatus" 
                    class="refresh-btn"
                    title="检查更新"
                >
                    🔄
                </button>
            </div>
        </div>
    </div>
</div>

<div class="editor-container" :class="{ 'disabled': !isInstalled }">
    <!-- 未安装遮罩 -->
    <div v-if="!isInstalled" class="install-overlay">
        <div class="overlay-content">
            <div class="overlay-icon">🤖</div>
            <h3>需要安装AI系统</h3>
            <p>行为树编辑器需要安装AI系统才能正常使用</p>
            <div class="overlay-actions">
                <button 
                    @click="handleInstall" 
                    :disabled="isInstalling"
                    class="overlay-install-btn"
                    :class="{ 'installing': isInstalling }"
                >
                    <span>{{ isInstalling ? '⏳ 安装中...' : '📦 立即安装AI系统' }}</span>
                    <div v-if="isInstalling" class="loading-spinner"></div>
                </button>
            </div>
            <div class="overlay-note">
                <small>📝 安装完成后编辑器将自动可用</small>
            </div>
        </div>
    </div>
    <!-- 左侧节点面板 -->
    <div class="nodes-panel">
        <div class="panel-header">
            <h3>📦 节点库</h3>
            <input 
                type="text" 
                v-model="nodeSearchText" 
                placeholder="搜索节点..." 
                class="search-input"
            >
        </div>
        
        <div class="node-categories">
            <!-- 根节点 -->
            <div class="category">
                <h4 class="category-title">🌳 根节点</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredRootNodes()" 
                        :key="node.type"
                        class="node-item root"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- 复合节点 -->
            <div class="category">
                <h4 class="category-title">🔗 复合节点</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredCompositeNodes()" 
                        :key="node.type"
                        class="node-item composite"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- 装饰器节点 -->
            <div class="category">
                <h4 class="category-title">🎭 装饰器</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredDecoratorNodes()" 
                        :key="node.type"
                        class="node-item decorator"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- 动作节点 -->
            <div class="category">
                <h4 class="category-title">⚡ 动作节点</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredActionNodes()" 
                        :key="node.type"
                        class="node-item action"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- 条件节点 -->
            <div class="category">
                <h4 class="category-title">❓ 条件节点</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredConditionNodes()" 
                        :key="node.type"
                        class="node-item condition"
                        :class="{ 'draggable-condition': node.isDraggableCondition }"
                        :draggable="true"
                        @dragstart="handleConditionNodeDragStart($event, node)"
                        :title="node.description + (node.isDraggableCondition ? ' (可拖拽到条件装饰器)' : '')"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                        <span v-if="node.isDraggableCondition" class="drag-hint">🎯</span>
                    </div>
                </div>
            </div>

            <!-- ECS节点 -->
            <div class="category">
                <h4 class="category-title">🎮 ECS节点</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredECSNodes()" 
                        :key="node.type"
                        class="node-item ecs"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 中间画布区域 -->
    <div class="canvas-container">
        <div class="canvas-toolbar">
            <div class="zoom-controls">
                <button @click="zoomIn">🔍+</button>
                <span>{{ Math.round(zoomLevel * 100) }}%</span>
                <button @click="zoomOut">🔍-</button>
                <button @click="resetZoom">重置</button>
            </div>
            <div class="canvas-actions">
                <button @click="centerView">居中</button>
                <button @click="autoLayout">自动布局</button>
                <button @click="validateTree">验证</button>
                <button @click="clearAllConnections" title="清除所有连接线" v-if="connections.length > 0">清除连线</button>
            </div>
        </div>
        
        <div 
            ref="canvasAreaRef"
            class="canvas-area"
            :class="{ 
                'connecting': dragState.isConnecting,
                'condition-dragging': conditionDragState.isDraggingCondition 
            }"
            @drop="handleCanvasDrop"
            @dragover="onCanvasDragOver"
            @wheel="onCanvasWheel"
            @mousedown="onCanvasMouseDown"
            @mousemove="onCanvasMouseMove"
            @mouseup="onCanvasMouseUp"
        >
            <canvas 
                :width="canvasWidth" 
                :height="canvasHeight"
                class="behavior-tree-canvas"
            ></canvas>
            
            <!-- 连接线绘制层 -->
            <svg 
                ref="svgRef"
                class="connection-layer" 
                :width="canvasWidth" 
                :height="canvasHeight"
            >
                <g :transform="'translate(' + panX + ', ' + panY + ') scale(' + zoomLevel + ')'">
                    <path 
                        v-for="connection in connections" 
                        :key="connection.id"
                        :d="connection.path"
                        class="connection-line"
                        :class="{ 'connection-active': connection.active }"
                        @click="onConnectionClick($event, connection.id)"
                        :title="'点击删除连接线 (' + connection.sourceId + ' → ' + connection.targetId + ')'"
                    />
                    <!-- 临时连接线 -->
                    <path 
                        v-if="connectionState.tempPath"
                        :d="connectionState.tempPath"
                        class="connection-temp"
                    />
                </g>
            </svg>
            
            <!-- 节点渲染层 -->
            <div 
                class="nodes-layer" 
                :style="{ transform: 'translate(' + panX + 'px, ' + panY + 'px) scale(' + zoomLevel + ')' }"
            >
                <div 
                    v-for="node in treeNodes" 
                    :key="node.id"
                    :data-node-id="node.id"
                    class="tree-node"
                    :class="[
                        'node-' + node.type, 
                        { 
                            'node-selected': selectedNodeId === node.id,
                            'node-error': node.hasError,
                            'dragging': dragState.dragNode && dragState.dragNode.id === node.id,
                            'condition-hover': conditionDragState.hoveredDecoratorId === node.id,
                            'can-accept-condition': canAcceptCondition(node) && conditionDragState.isDraggingCondition
                        }
                    ]"
                    :style="{ 
                        left: node.x + 'px', 
                        top: node.y + 'px' 
                    }"
                    @click="selectNode(node.id)"
                    @mousedown="startNodeDrag($event, node)"
                    @drop="handleNodeDrop($event, node)"
                    @dragover="handleNodeDragOver($event, node)"
                    @dragleave="handleNodeDragLeave($event, node)"
                >
                    <div class="node-header">
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-title">{{ node.name }}</span>
                        <button class="node-delete" @click.stop="deleteNode(node.id)">×</button>
                    </div>
                    <div class="node-body">
                        <div v-if="node.description" class="node-description">{{ node.description }}</div>
                        
                        <!-- 条件装饰器的条件显示 -->
                        <div v-if="node.type === 'conditional-decorator'" class="condition-attachment-area">
                            <div v-if="node.attachedCondition" class="attached-condition">
                                <div 
                                    class="condition-info"
                                    :class="{ 'condition-selected': selectedConditionNodeId === node.id }"
                                    @click.stop="selectConditionNode(node)"
                                    title="点击编辑条件属性"
                                >
                                    <span class="condition-icon">{{ node.attachedCondition.icon }}</span>
                                    <span class="condition-text">{{ getConditionDisplayText(node) }}</span>
                                    <span class="edit-hint">📝</span>
                                </div>
                                <button 
                                    class="remove-condition-btn" 
                                    @click.stop="removeConditionFromDecorator(node)"
                                    title="移除条件"
                                >×</button>
                            </div>
                            <div v-else class="condition-placeholder">
                                <span class="placeholder-text">🎯 拖拽条件到此处</span>
                            </div>
                        </div>
                        
                        <!-- 节点属性预览 -->
                        <div v-if="hasVisibleProperties(node)" class="node-properties-preview">
                            <div 
                                v-for="(prop, key) in getVisibleProperties(node)" 
                                :key="key"
                                class="property-preview-item"
                                :title="prop.name + ': ' + prop.description"
                            >
                                <span class="property-label">{{ prop.name }}:</span>
                                <span class="property-value" :class="'property-' + prop.type">
                                    {{ formatPropertyValue(prop) }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 输入端口 -->
                    <div 
                        v-if="node.canHaveParent"
                        class="port port-input"
                        :class="{ 
                            'connecting': connectionState.isConnecting && 
                                         connectionState.startPortType === 'output' && 
                                         connectionState.startNodeId !== node.id,
                            'drag-target': isValidConnectionTarget(node.id, 'input')
                        }"
                        @mousedown.stop="startConnection($event, node.id, 'input')"
                        @mouseenter="onPortHover(node.id, 'input')"
                        @mouseleave="onPortLeave()"
                        title="执行流入口"
                    >
                        <div class="port-inner"></div>
                    </div>
                    
                    <!-- 输出端口 -->
                    <div 
                        v-if="node.canHaveChildren"
                        class="port port-output"
                        :class="{ 
                            'connecting': connectionState.isConnecting && 
                                         connectionState.startPortType === 'input' && 
                                         connectionState.startNodeId !== node.id,
                            'drag-target': isValidConnectionTarget(node.id, 'output')
                        }"
                        @mousedown.stop="startConnection($event, node.id, 'output')"
                        @mouseenter="onPortHover(node.id, 'output')"
                        @mouseleave="onPortLeave()"
                        title="执行流出口"
                    >
                        <div class="port-inner"></div>
                    </div>

                    <div v-if="node.children && node.children.length > 0" class="children-indicator">
                        {{ node.children.length }}
                    </div>
                </div>
            </div>
            

            <div class="grid-background" :style="gridStyle()"></div>
        </div>
    </div>


    <div class="properties-panel-container">

        <div class="properties-panel">
            <div class="panel-header">
                <h3>⚙️ 属性面板</h3>
            </div>
            
            <div v-if="activeNode" class="node-properties">
                <div class="property-section">
                    <h4>基本信息</h4>
                    <div class="property-item">
                        <label>节点名称:</label>
                        <input 
                            type="text" 
                            :value="activeNode.name" 
                            @input="updateNodeProperty('name', $event.target.value)"
                            :key="activeNode.id + '_name'"
                            :disabled="activeNode.isConditionNode"
                        >
                    </div>
                    <div class="property-item">
                        <label>描述:</label>
                        <textarea 
                            :value="activeNode.description"
                            @input="updateNodeProperty('description', $event.target.value)"
                            :key="activeNode.id + '_description'"
                            :disabled="activeNode.isConditionNode"
                        ></textarea>
                    </div>
                </div>

                <div class="property-section" v-if="activeNode.properties">
                    <h4>节点属性</h4>
                    <div 
                        v-for="(prop, key) in activeNode.properties" 
                        :key="key"
                        class="property-item"
                        :class="{ 'blackboard-droppable': isBlackboardDroppable(prop) }"
                        @drop="handleBlackboardDrop($event, key)"
                        @dragover="handleBlackboardDragOver"
                        @dragleave="handleBlackboardDragLeave"
                    >
                        <label>{{ prop.name }}:</label>
                        <div class="property-input-container">
                            <input 
                                v-if="prop.type === 'string'"
                                type="text" 
                                :value="prop.value"
                                @input="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                                :key="activeNode.id + '_' + key + '_string'"
                                :placeholder="'拖拽Blackboard变量或直接输入'"
                            >
                            <input 
                                v-else-if="prop.type === 'number'"
                                type="number" 
                                :value="prop.value"
                                @input="updateNodeProperty('properties.' + key + '.value', parseFloat($event.target.value) || 0)"
                                :key="activeNode.id + '_' + key + '_number'"
                                :placeholder="'拖拽Blackboard变量或直接输入'"
                            >
                            <input 
                                v-else-if="prop.type === 'boolean'"
                                type="checkbox" 
                                :checked="prop.value"
                                @change="updateNodeProperty('properties.' + key + '.value', $event.target.checked)"
                                :key="activeNode.id + '_' + key + '_boolean'"
                            >
                            <textarea 
                                v-else-if="prop.type === 'code'"
                                :value="prop.value"
                                @input="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                                rows="6"
                                class="code-input"
                                placeholder="请输入代码..."
                                :key="activeNode.id + '_' + key + '_code'"
                            ></textarea>
                            <select 
                                v-else-if="prop.type === 'select'"
                                :value="prop.value"
                                @change="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                                :key="activeNode.id + '_' + key + '_select_' + prop.value"
                            >
                                <option 
                                    v-for="option in prop.options" 
                                    :key="option" 
                                    :value="option"
                                    :selected="option === prop.value"
                                >
                                    {{ option }}
                                </option>
                            </select>
                            
                            <div v-if="isBlackboardReference(prop.value)" class="blackboard-reference">
                                <span class="ref-icon">🔗</span>
                                <span class="ref-text">{{ prop.value }}</span>
                                <button class="clear-ref" @click="clearBlackboardReference(key)" title="清除引用">×</button>
                            </div>
                        </div>
                        <p v-if="prop.description" class="property-help">{{ prop.description }}</p>
                    </div>
                </div>

                <div class="property-section">
                    <h4>节点配置</h4>
                    <pre class="config-preview">{{ activeNode ? JSON.stringify(activeNode, null, 2) : '{}' }}</pre>
                </div>
            </div>
            
            <div v-else class="no-selection">
                <p>请选择一个节点查看属性</p>
            </div>
        </div>
    </div>
</div>


<div class="tree-structure-panel" v-if="rootNode()">
    <div class="panel-header">
        <h3>🌲 树结构</h3>
    </div>
    <div class="tree-view">
        <tree-node-item 
            :node="rootNode()"
            :level="0"
            :get-node-by-id-local="getNodeByIdLocal"
            @node-select="selectNode"
        ></tree-node-item>
    </div>
</div>


<div v-if="!validationResult().isValid" class="validation-error">
    <span class="error-icon">⚠️</span>
    <span>{{ validationResult().message }}</span>
</div>


<div v-if="showBlackboardModal" class="modal-overlay" @click="showBlackboardModal = false">
    <div class="modal-content blackboard-modal" @click.stop>
        <div class="modal-header">
            <h3>{{ editingBlackboardVariable ? '编辑变量' : '添加变量' }}</h3>
            <button @click="showBlackboardModal = false">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>变量名称:</label>
                <input 
                    type="text" 
                    v-model="blackboardModalData.name" 
                    placeholder="例如：playerHealth、enemyCount..."
                    :disabled="editingBlackboardVariable"
                    class="form-input"
                >
            </div>
            
            <div class="form-group">
                <label>变量类型:</label>
                <select v-model="blackboardModalData.type" class="form-select">
                    <option value="string">📝 字符串 (string)</option>
                    <option value="number">🔢 数字 (number)</option>
                    <option value="boolean">☑️ 布尔值 (boolean)</option>
                    <option value="vector2">📐 二维向量 (vector2)</option>
                    <option value="vector3">📏 三维向量 (vector3)</option>
                    <option value="object">📦 对象 (object)</option>
                    <option value="array">📋 数组 (array)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>默认值:</label>
                <input 
                    v-if="blackboardModalData.type === 'string'"
                    type="text" 
                    v-model="blackboardModalData.defaultValue" 
                    placeholder="输入默认字符串值..."
                    class="form-input"
                >
                <input 
                    v-else-if="blackboardModalData.type === 'number'"
                    type="number" 
                    v-model="blackboardModalData.defaultValue" 
                    placeholder="输入默认数值..."
                    class="form-input"
                >
                <div v-else-if="blackboardModalData.type === 'boolean'" class="checkbox-group">
                    <input 
                        type="checkbox" 
                        v-model="blackboardModalData.defaultValue"
                        id="defaultBoolValue"
                    >
                    <label for="defaultBoolValue">默认为 True</label>
                </div>
                <textarea 
                    v-else
                    v-model="blackboardModalData.defaultValue" 
                    placeholder="请输入JSON格式的默认值，例如：{&quot;x&quot;: 0, &quot;y&quot;: 0}"
                    rows="3"
                    class="form-textarea"
                ></textarea>
            </div>
            
            <div class="form-group">
                <label>描述:</label>
                <textarea 
                    v-model="blackboardModalData.description" 
                    placeholder="描述这个变量的用途和作用..."
                    rows="2"
                    class="form-textarea"
                ></textarea>
            </div>
            
            <div class="form-group">
                <label>分组:</label>
                <input 
                    type="text" 
                    v-model="blackboardModalData.group" 
                    placeholder="例如：Player、AI、Environment、Game..."
                    class="form-input"
                >
            </div>
            
            <div v-if="blackboardModalData.type === 'number'" class="form-group">
                <label>数值约束:</label>
                <div class="constraint-inputs">
                    <div class="constraint-row">
                        <label>最小值:</label>
                        <input type="number" v-model="blackboardModalData.constraints.min" placeholder="不限制" class="form-input">
                    </div>
                    <div class="constraint-row">
                        <label>最大值:</label>
                        <input type="number" v-model="blackboardModalData.constraints.max" placeholder="不限制" class="form-input">
                    </div>
                    <div class="constraint-row">
                        <label>步长:</label>
                        <input type="number" v-model="blackboardModalData.constraints.step" placeholder="1" class="form-input">
                    </div>
                </div>
            </div>
            
            <div v-if="blackboardModalData.type === 'string'" class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" v-model="blackboardModalData.useAllowedValues" id="useAllowedValues">
                    <label for="useAllowedValues">限制可选值</label>
                </div>
                <div v-if="blackboardModalData.useAllowedValues" class="allowed-values">
                    <textarea 
                        v-model="blackboardModalData.allowedValuesText" 
                        placeholder="每行输入一个可选值&#10;例如：&#10;idle&#10;running&#10;jumping&#10;attacking"
                        rows="4"
                        class="form-textarea"
                    ></textarea>
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" v-model="blackboardModalData.readOnly" id="readOnlyVar">
                <label for="readOnlyVar">只读变量</label>
            </div>
        </div>
        <div class="modal-footer">
            <button @click="saveBlackboardVariable" class="save-btn">保存</button>
            <button @click="showBlackboardModal = false" class="cancel-btn">取消</button>
        </div>
    </div>
</div>


<div class="blackboard-sidebar" 
     :class="{ 
         'collapsed': blackboardCollapsed, 
         'transparent': blackboardTransparent 
     }"
     @mouseenter="blackboardTransparent = false"
     @mouseleave="blackboardTransparent = true">
    
    <button class="blackboard-toggle" 
            @click="blackboardCollapsed = !blackboardCollapsed"
            :title="blackboardCollapsed ? '展开 Blackboard' : '收缩 Blackboard'">
        <span v-if="blackboardCollapsed">📋</span>
        <span v-else>◀</span>
    </button>
    
    <div class="blackboard-content" v-show="!blackboardCollapsed">
        <div class="blackboard-header">
            <h3>📋 Blackboard</h3>
        </div>
        
        <div class="blackboard-actions">
            <button @click="showBlackboardModal = true" class="add-var-btn">+ 添加变量</button>
            <button @click="clearBlackboard" v-if="blackboardVariables.length > 0" class="clear-btn">清空</button>
        </div>
        
        <div class="blackboard-scroll-area">
            <div v-if="blackboardVariables.length > 0" class="blackboard-groups">
                <div 
                    v-for="[groupName, variables] in groupedBlackboardVariables()" 
                    :key="groupName" 
                    class="variable-group"
                >
                    <h4 class="group-title">{{ groupName }}</h4>
                    <div class="variable-list">
                        <div 
                            v-for="variable in variables" 
                            :key="variable.name"
                            class="variable-item"
                            :class="variable.type"
                            :draggable="true"
                            @dragstart="onBlackboardDragStart($event, variable)"
                            :title="variable.description"
                        >
                            <div class="variable-header">
                                <span class="variable-name">{{ variable.name }}</span>
                                <span class="variable-type">{{ getTypeDisplayName(variable.type) }}</span>
                                <div class="variable-actions">
                                    <button @click="editBlackboardVariable(variable)" class="edit-btn">✏️</button>
                                    <button @click="removeBlackboardVariable(variable.name)" class="remove-btn">🗑️</button>
                                </div>
                            </div>
                            
                            <div class="variable-value">
                                <select 
                                    v-if="variable.constraints && variable.constraints.allowedValues" 
                                    v-model="variable.value"
                                    @change="onBlackboardValueChange(variable)"
                                    :disabled="variable.readOnly"
                                >
                                    <option 
                                        v-for="option in variable.constraints.allowedValues" 
                                        :key="option" 
                                        :value="option"
                                    >
                                        {{ option }}
                                    </option>
                                </select>
                                <span v-else class="value-display">{{ getDisplayValue(variable) }}</span>
                            </div>
                            
                            <div v-if="variable.constraints && hasVisibleConstraints(variable)" class="variable-constraints">
                                <small>{{ formatConstraints(variable.constraints) }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                          
            <div v-else class="empty-blackboard">
                <div class="empty-icon">📋</div>
                <p>还没有定义任何变量</p>
                <button class="add-first-var" @click="showBlackboardModal = true">添加第一个变量</button>
            </div>
        </div>
    </div>
</div>



<div v-if="showExportModal" class="modal-overlay" @click="showExportModal = false">
    <div class="modal-content" @click.stop>
        <div class="modal-header">
            <h3>导出配置</h3>
            <button @click="showExportModal = false">×</button>
        </div>
        <div class="modal-body">
            <div class="export-options">
                <label>
                    <input type="radio" v-model="exportFormat" value="json"> JSON配置
                </label>
                <label>
                    <input type="radio" v-model="exportFormat" value="typescript"> TypeScript代码
                </label>
            </div>
            <textarea 
                class="export-code" 
                :value="exportedCode()" 
                readonly
            ></textarea>
        </div>
        <div class="modal-footer">
            <button @click="copyToClipboard">复制到剪贴板</button>
            <button @click="saveToFile">保存到文件</button>
            <button @click="showExportModal = false">关闭</button>
        </div>
    </div>
</div> 